<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theoretical Horse Pedigree Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body>
    <div id="app" class="pt-12">
        <!-- Content inserted by JavaScript -->
    </div>

    <!-- JavaScript code is injected here -->
    <script>
        // --- Initialization and Utility Functions ---

        /**
         * Function to convert a base64 string to an ArrayBuffer.
         */
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        /**
         * Implements exponential backoff for API retries.
         */
        const withBackoff = async (fn, maxRetries = 5, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Max retries reached. Failing.", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        };

        // --- Global State Variables ---

        const initialPromptText = "A detailed, theoretical, four-level horse pedigree chart for a foal named 'The resulting Oguru Cap (Horse)'. The chart must be drawn on a clean white background with elegant lines and text, resembling an official document or racing pedigree. The chart must strictly follow this structure: Level 1 (Foal): The resulting Oguru Cap (Horse). Level 2 (Parents): Sire is Vodka, Dam is Winning Ticket. Level 3 (Grandparents): For Vodka, the Sire is Oguri Cap and the Dam is Winning Ticket. For Winning Ticket, the Sire is Oguri Cap and the Dam is Mejiro Ryan. Use professional, clear typography and connecting lines to show the lineage.";
        
        let currentImage = null;
        let isLoading = false;
        let message = "Edit the prompt below and click 'Generate Pedigree Chart'.";
        let apiKey = ""; // Canvas will provide this if needed
        let currentPrompt = initialPromptText; // New state variable for the editable prompt

        // --- Core Functions ---

        /**
         * Main function to call the image generation API.
         */
        async function generateImage() {
            // Use the editable prompt from the global state
            const prompt = currentPrompt;

            if (isLoading || !prompt.trim()) return; // Prevent double-clicks or empty prompts
            
            isLoading = true;
            message = "Generating image... Please wait.";
            updateUI();

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            try {
                const response = await withBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    currentImage = `data:image/png;base64,${base64Data}`;
                    message = "Pedigree chart generated successfully.";
                } else {
                    message = "Error: Could not retrieve image data. Try a different prompt.";
                    console.error("API response error:", result);
                }

            } catch (error) {
                message = "An error occurred during API call. Check console for details.";
                console.error("Fetch failed:", error);
            } finally {
                isLoading = false;
                updateUI();
            }
        }

        /**
         * Updates the user interface based on the current state.
         */
        function updateUI() {
            const app = document.getElementById('app');
            if (!app) return;

            // Determine button state and label
            const buttonText = isLoading ? 'Generating...' : 'Generate Pedigree Chart';
            const buttonClass = isLoading ? 'bg-indigo-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700';

            app.innerHTML = `
                <div class="p-6 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold mb-4 text-gray-800">Theoretical Horse Pedigree Generator</h1>

                    <!-- Prompt Textarea for editing -->
                    <div class="mb-6">
                        <label for="prompt-input" class="block text-sm font-semibold text-gray-700 mb-2">Image Generation Prompt:</label>
                        <textarea id="prompt-input" oninput="currentPrompt = this.value"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm h-32 resize-y shadow-sm"
                            placeholder="Enter your detailed image generation prompt here...">${currentPrompt}</textarea>
                        <p class="text-xs text-gray-500 mt-1">The image model uses this text to draw the family tree.</p>
                    </div>

                    <button onclick="generateImage()" ${isLoading ? 'disabled' : ''}
                            class="w-full text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out ${buttonClass} shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        ${buttonText}
                    </button>

                    <div class="mt-8">
                        <p id="status-message" class="text-center text-sm mb-4 ${isLoading ? 'text-indigo-600' : 'text-gray-600'}">
                            ${message}
                        </p>

                        <div id="image-container" class="border-4 border-dashed border-gray-300 rounded-xl flex items-center justify-center p-4 min-h-[500px] bg-gray-50 shadow-inner">
                            ${currentImage ?
                                `<img src="${currentImage}" alt="Generated Pedigree Chart" class="max-w-full max-h-[75vh] h-auto rounded-lg shadow-2xl transition duration-500 ease-in-out transform hover:scale-[1.01]"/>`
                                :
                                `<div class="text-center text-gray-500 p-8">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">No Image Generated Yet</h3>
                                    <p class="mt-1 text-sm text-gray-500">Click the button above to create the family tree.</p>
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `;
            // Ensure the global currentPrompt variable is updated when the textarea value changes.
            // Since oninput is inline, we only need to ensure the supporting functions are global.
        }

        // --- Global Exports & Initialization ---

        // We make these functions global so they can be called from the inline 'onclick' and 'oninput' attributes.
        window.generateImage = generateImage;
        window.updateUI = updateUI;
        window.currentPrompt = currentPrompt; // Export the state variable for direct access by oninput

        window.onload = () => {
            const appContainer = document.getElementById('app');
            if (appContainer) {
                // Ensure initial state variable is set before calling updateUI
                currentPrompt = initialPromptText;
                updateUI();
            }
        };

    </script>
</body>
</html>
